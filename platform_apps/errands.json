{
    "name": "Errands",
    "conditions": "ContractConditions(\"@1DeveloperCondition\")",
    "data": [
        {
            "Name": "default_menu",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "MenuItem(Title: $@1errands$, Page: @1errand_list, Icon: \"icon-envelope\")",
            "Type": "menu"
        },
        {
            "Name": "config",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "{\n    \"name\": \"Errands\",\n    \"conditions\": \"ContractConditions(\\\"DeveloperCondition\\\")\",\n    \"data\": [\n        {\n            \"Name\": \"default_menu\",\n            \"Conditions\": \"ContractConditions(\\\"DeveloperCondition\\\")\",\n            \"Value\": \"MenuItem(Title: $@1errands$, Page: @1errand_list, Icon: \\\"icon-envelope\\\")\",\n            \"Type\": \"menu\"\n        },\n        {\n            \"Name\": \"errands_access\",\n            \"Conditions\": \"ContractConditions(\\\"DeveloperCondition\\\")\",\n            \"Value\": \"0\",\n            \"Type\": \"app_params\"\n        },\n        {\n            \"Name\": \"errands_admin_role\",\n            \"Conditions\": \"ContractConditions(\\\"DeveloperCondition\\\")\",\n            \"Value\": \"0\",\n            \"Type\": \"app_params\"\n        }\n    ]\n}",
            "Type": "app_params"
        },
        {
            "Name": "errands_access",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "0",
            "Type": "app_params"
        },
        {
            "Name": "errands_admin_role",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "0",
            "Type": "app_params"
        },
        {
            "Name": "errand_create",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "SetVar(this_page,\"@1errand_create\")\n\nIf(#EcosystemId# == #ecosystem_id#){\n    SetVar(errand_type,1)\n}\nIf(#errand_type#==\"\"){\n    SetVar(errand_type,0)\n}\nIf(#MemberId# == \"\"){\n    SetVar(MemberId, 0)\n}\n\nForm(){\n    Div(row mb-sm){\n        Div(col-md-3 mt-sm text-right){\n            Label(){\n                $@1errand_performer$\n                Span(*,text-danger)\n            }\n        }\n        Div(col-md-9 mt-sm text-left){\n            If(#errand_type#==0){\n                Button(Body: $@1role$, Class: btn-xs btn-primary mr-sm disabled)\n                Button(Body: $@1member$, Page: #this_page#, PageParams: \"errand_type=1,type=#type#\", Class: btn-xs btn-default).Popup(50, \"$@1new_errand$\")\n\n            }.ElseIf(#errand_type#==1){\n                Button(Body: $@1role$, Page: #this_page#, PageParams: \"errand_type=0,type=#type#\", Class: btn-xs btn-default mr-sm).Popup(50, \"$@1new_errand$\")\n                Button(Body: $@1member$, Class: btn-xs btn-primary disabled)\n            }\n        }\n    }\n    Div(row mt-sm){\n        Div(col-md-3 mt-sm text-right){\n            Label(){\n                If(#errand_type#==0){\n                    $@1choose_role_errand$\n                }.ElseIf(#errand_type#==1){\n                    $@1recipient$\n                }\n                Span(*,text-danger)\n            }\n        }\n        Div(col-md-9 text-left){\n            If(#errand_type#==0){\n                DBFind(@1roles, src_roles).Where({\"ecosystem\": #ecosystem_id#, \"deleted\": 0}).Columns(\"id,role_name\")\n                Select(Name: RecRoleId, Source: src_roles, NameColumn: role_name, ValueColumn: id)\n            }.ElseIf(#errand_type#==1){\n                Input(Name: MemberId, Type:hidden, Value: #MemberId#)\n                Div(input-group){\n                    If(#MemberId# != 0){\n                        SetVar(AddressMemberId, Address(#MemberId#))\n                        Input(Name: m_name, Disabled: 1, Value: #AddressMemberId#)\n                    }.Else{\n                        Input(Name: m_name, Disabled: 1, Value: \"xxxx-xxxx-xxxx-xxxx-xxxx\")\n                    }\n                    Div(input-group-btn){\n                        Button(Class: btn bg-gray-lighter fa fa-caret-down buttons, Page: @1select_wallet, PageParams:\"back_page=#this_page#,back_header=$@1send$,EcosystemId=#ecosystem_id#\").Popup(Header: $@1member$, Width: \"50\")\n                    }.Style(\n                        .buttons{border: 1px solid #dde6e9;}\n                    )\n                }\n            }\n        }\n    }\n    If(And(#MemberId# != 0, #errand_type# == 1)){\n        Div(row mt-sm){\n            Div(col-md-3 mt-sm text-right){\n                Label(){\n                    $@1name$\n                    Span(*,text-danger)\n                }\n            }\n            Div(col-md-9 text-left){\n                Input(Name: ErrandName, Value: $@1new_errand$)\n            }\n        }\n        Div(row mt-sm){\n            Div(col-md-3 mt-sm text-right){\n                Label(For: end_date){\n                    $@1date_end$\n                    Span(*,text-danger)\n                }\n            }\n            Div(col-md-9 text-left){\n                Div(row){\n                    Div(col-md-6){\n                        Input(Name: end_date, Type: date)\n                    }\n                    Div(col-md-6){\n                        Input(Name: end_time, Type: time, Value: \"00:00\")\n                    }\n                }\n            }\n        }\n        Div(row mt-sm){\n            Div(col-md-3 mt text-right){\n                Label(){\n                    $@1body_text$\n                    Span(*,text-danger)\n                }\n            }\n            Div(col-md-9 text-left){\n                Input(Name: ErrandText,Type: textarea)\n            }\n        }\n    }.ElseIf(#errand_type#==0){\n        If(#role_type_errand# != 2){\n            SetVar(role_type_errand,1)\n        }\n        Div(row mt-sm){\n            Div(col-md-3 mt-sm text-right){\n                Label(){\n                    $@1type_role_errand$\n                    Span(*,text-danger)\n                }\n            }\n            Div(col-md-9 mt-sm text-left){\n                If(And(#errand_type#==0,#role_type_errand# == 1)){\n                    Button(Body: $@1one_role_representative$, Class: btn-xs btn-primary mr-sm disabled)\n                    Button(Body: $@1all_roles_member$, Page: #this_page#, PageParams: \"errand_type=0,role_type_errand=2\", Class: btn-xs btn-default).Popup(50, \"$@1new_errand$\")\n                }.ElseIf(And(#errand_type#==0,#role_type_errand# == 2)){\n                    Button(Body: $@1one_role_representative$, Page: #this_page#, PageParams: \"errand_type=0,role_type_errand=1\", Class: btn-xs btn-default mr-sm).Popup(50, \"$@1new_errand$\")\n                    Button(Body: $@1all_roles_member$, Class: btn-xs btn-primary disabled)\n                }\n            }\n        }\n        Div(row mt-sm){\n            Div(col-md-3 mt-sm text-right){\n                Label(){\n                    $@1name$\n                    Span(*,text-danger)\n                }\n            }\n            Div(col-md-9 text-left){\n                Input(Name: ErrandName, Value: $@1new_errand$)\n            }\n        }\n        Div(row mt-sm){\n            Div(col-md-3 mt-sm text-right){\n                Label(For: end_date){\n                    $@1date_end$\n                    Span(*,text-danger)\n                }\n            }\n            Div(col-md-9 text-left){\n                Div(row){\n                    Div(col-md-6){\n                        Input(Name: end_date, Type: date)\n                    }\n                    Div(col-md-6){\n                        Input(Name: end_time, Type: time, Value: \"00:00\")\n                    }\n                }\n            }\n        }\n        Div(row mt-sm){\n            Div(col-md-3 mt text-right){\n                Label(){\n                    $@1body_text$\n                    Span(*,text-danger)\n                }\n            }\n            Div(col-md-9 text-left){\n                Input(Name: ErrandText,Type: textarea)\n            }\n        }\n    }\n    Div(row mt){\n        Div(col-md-12){\n            Input(Name: SendRoleId, Class: hidden, Value: #role_id#)\n            Button(Body: $@1send$, Class: btn btn-primary pull-right, PageParams:\"type=#type#\", Page: @1errand_list, Contract: @1ErrandCreate, Params: \"ErrandType=#errand_type#,RoleTypeErrand=#role_type_errand#\")\n            Button(Body: $@1back$, Class: btn btn-default pull-right, PageParams:\"type=#type#\", Page: @1errand_list)\n        }\n    }\n}\n",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "errand_list",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "SetVar(this_page, @1errand_list).(this_table, @1notifications)\nInclude(@1pager_header)\n\nIf(#page_par#!=\"\"){\n    SetVar(Name: type, Value: #page_par#)\n}\nIf(And(#type#!=0,#type#!=1)){\n    SetVar(Name: type, Value: 0)\n}\n\nSetTitle($@1errands$)\nDBFind(\"@1applications\").Where({\"ecosystem\": #ecosystem_id#, \"name\": \"Errands\"}).Vars(application)\nSetVar(admin_roles, AppParam(Ecosystem: #ecosystem_id#, App: #application_id#, Name: errands_admin_role))\nDBFind(\"@1roles_participants\").Where({\"ecosystem\": #ecosystem_id#, \"role->id\": {\"$in\": [#admin_roles#]}, \"member->member_id\": #key_id#, \"deleted\": 0}).Vars(admin_access)\nSetVar(create_roles, AppParam(Ecosystem: #ecosystem_id#, App: #application_id#, Name: errands_access))\nDBFind(\"@1roles_participants\").Where({\"ecosystem\": #ecosystem_id#, \"$and\": [\"role->id\": {\"$in\": [#create_roles#]}, \"role->id\": #role_id#], \"member->member_id\": #key_id#, \"deleted\": 0}).Vars(create_access)\nIf(#create_access_id# > 0){\n    AddToolButton(Title: $@1new_errand$, Page: @1errand_create, PageParams:\"type=#type#\", Icon: icon-plus).Popup(50, \"$@1new_errand$\")\n}\n\nDiv(btn-group){\n    Div(btn-group ml-lg){\n        If(#type#==0){\n            Button(Body: Em(Class: fa fa-user) $@1individual_errands$, Page: @1errand_list, PageParams: \"type=0\", Class: btn bg-gray-lighter ml-sm)\n        }.Else{\n            Button(Body: Em(Class: fa fa-user) $@1individual_errands$, Page: @1errand_list, PageParams: \"type=0\", Class: btn bg-gray ml-sm)\n        }\n        If(#type#==1){\n            Button(Body: Em(Class: fa fa-users) $@1roles_errands$, Page: @1errand_list, PageParams: \"type=1\", Class: btn bg-gray-lighter ml-sm)\n        }.Else{\n            Button(Body: Em(Class: fa fa-users) $@1roles_errands$, Page: @1errand_list, PageParams: \"type=1\", Class: btn bg-gray ml-sm)\n        }\n        If(#admin_access_id#>0){\n            Button(Body: Em(Class: fa fa-refresh) $@1update_statuses$, Class: btn btn-default ml-lg, Page: @1errand_list, PageParams: \"type=#type#\", Contract: @1ErrandStatusUpdate)\n        }\n    }\n    Div(btn-group mr-lg pull-right){\n        If(#search#){\n            Button(Class: btn bg-gray-lighter, Page: @1errand_list, PageParams: \"Status=0,search=#search#,type=#type#\"){Span(Body: Em(Class: fa fa-hourglass-half), Class: text-primary)}\n            Button(Class: btn bg-gray-lighter, Page: @1errand_list, PageParams: \"Status=1,search=#search#,type=#type#\"){Span(Body: Em(Class: fa fa-hourglass-end), Class: text-success)}\n            Button(Class: btn bg-gray-lighter, Page: @1errand_list, PageParams: \"Status=-1,search=#search#,type=#type#\"){Span(Body: Em(Class: fa fa-times), Class: text-danger)}\n        }.Else{\n            Button(Class: btn bg-gray-lighter, Page: @1errand_list, PageParams: \"Status=0,type=#type#\"){Span(Body: Em(Class: fa fa-hourglass-half), Class: text-primary)}\n            Button(Class: btn bg-gray-lighter, Page: @1errand_list, PageParams: \"Status=1,type=#type#\"){Span(Body: Em(Class: fa fa-hourglass-end), Class: text-success)}\n            Button(Class: btn bg-gray-lighter, Page: @1errand_list, PageParams: \"Status=-1,type=#type#\"){Span(Body: Em(Class: fa fa-times), Class: text-danger)}\n        }\n    }\n    If(Or(#search#!=\"\",#Status#==-1,#Status#==0,#Status#==1)){\n        Span(Button(Class: btn btn-link pull-right, Page: @1errand_list,PageParams: \"type=#type#\", Body: $@1clear_filters$)).Style(padding-left:10px)\n    }\n}\n\nIf(#type#==1){\n    SetVar(where_recipient, {\"recipient->role_id\": {\"$neq\": 0}})\n}.Else{\n    SetVar(where_recipient, {\"recipient->member_id\": {\"$neq\": 0}})\n}\n\nIf(Or(#Status#==-1,#Status#==0,#Status#==1)){\n    SetVar(where_status, {\"page_params->status\": #Status#})\n}\n\nIf(#search#){\n    SetVar(where_search, {\"page_params->name\": {\"$ilike\": \"#search#\"}})\n}\n\nSetVar(where, {\"$and\": [{\"ecosystem\": #ecosystem_id#}, {\"page_params->type\": \"task\"}, #where_recipient#, #where_status#, #where_search#]})\n\nDiv(list-group-item ml-lg mr-lg pt-lg){\n    SetVar(search_name, LangRes(@1name)).(page_par, #type#)\n    Include(@1search)\n}\n\nDBFind(#this_table#, src).Where(#where#).Order({\"id\": -1}).Limit(#pager_limit#).Offset(#pager_offset#).Columns(\"id,ecosystem,page_params->status,page_params->name,recipient->role_name,recipient->role_id,recipient->member_name,recipient->member_id,recipient->image_id,sender->image_id,sender->role_name,sender->role_id,date_created,page_params->date_end\").Custom(_status){\n    If(#page_params.status# == 0){\n        Span(Body:Em(Class:fa fa-hourglass-half) $@1in_progress$,Class: text-primary h5)\n    }.ElseIf(#page_params.status# == -1){\n        Span(Body:Em(Class:fa fa-times) $@1expired$,Class: text-danger h5)\n    }.ElseIf(#page_params.status# == 1){\n        Span(Body:Em(Class:fa fa-hourglass-end) $@1done$,Class: text-success h5)\n    }\n}.Custom(_role){\n    If(#recipient.role_id# > 0){\n        LinkPage(Class: text-primary h5 text-bold, Page: @1roles_view, PageParams: \"v_role_id=#recipient.role_id#\"){\n            Div(){\n                Span(Class: icon-people fa-2x mr-sm).(#recipient.role_name#)\n            }.Style(display:flex; align-items:center;)\n        }\n    }.ElseIf(#recipient.member_id# != 0){\n        LinkPage(Class: text-primary h5 text-bold, Page: @1profile_view, PageParams: \"v_key_id=#recipient.member_id#\"){\n            If(#recipient.image_id#>0){\n                Image(Src: Binary().ById(#recipient.image_id#), Class: img-circle).Style(height: 30px;width: 30px; border: 1px solid #5A5D63; margin-right: 10px;)\n                Span(#recipient.member_name#)\n            }.Else{\n                Div(){\n                    Span(Em(Class: fa icon-user fa-2x)).Style(margin-right:10px;)\n                    Span(#recipient.member_name#)\n                }.Style(display:flex; align-items:center;)\n            }\n        }\n    }\n}.Custom(_name){\n    LinkPage(#page_params.name#, Class: text-primary h5 text-bold,Page: @1errand_view,PageParams: \"errand_id=#id#,type=#type#\")\n}.Custom(custom_arrow){\n    Em(Class: fa fa-long-arrow-right fa-1x)\n}.Custom(_sender){\n    LinkPage(Class: text-primary h5 text-bold, Page: @1roles_view, PageParams: \"v_role_id=#sender.role_id#\"){\n        If(#sender.image_id#>0){\n            Image(Src: Binary().ById(#sender.image_id#), Class: mr-sm).Style(width: 30px; border: 1px solid #5A5D63;)\n            #sender.role_name#\n        }.Else{\n            Div(){\n                Span(Class: icon-people fa-2x mr-sm).(#sender.role_name#)\n            }.Style(display:flex; align-items:center;)\n        }\n    }\n}.Custom(_date_start){\n    Div(Class:h5){DateTime(DateTime: #date_created#, Format: \"YYYY.MM.DD HH:MI:SS\")}\n}.Custom(_date_end){\n    Div(Class:h5){Span(#page_params.date_end#)}\n}.Custom(_del){\n    If(#admin_access_id#>0){\n        Button(Body: Em(Class: text-danger fa fa-trash), Class: btn btn-default pull-right, Contract: @1ErrandDelete, Page: @1errand_list, Params: \"errand_id=#id#\", PageParams: \"type=#type#\")\n    }\n}.Count(count)\n\nDiv(fullscreen){\n    Div(table-responsive ml-lg mr-lg){\n        Div(list-group-item){\n            If(#count# > 0){\n                Table(src, \"$@1name$=_name,$@1sender$=_sender,=custom_arrow,$@1recipient$=_role,$@1date_start$=_date_start,$@1date_end$=_date_end,$@1status$=_status,=_del\")\n            }.Else{\n                Div(Class: text-center h4 text-muted, Body: \"$@1errands$ $@1not_founded$\")\n            }\n        }.Style(\n            margin-top:-15px;\n            tbody > tr:nth-of-type(odd) {\n                background-color: #f8f9fc;\n            }\n        )\n    }\n}\nDiv(mt-sm ml-lg mr-sm mb-sm){\n    Include(@1pager)\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "errand_view",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
<<<<<<< HEAD
            "Value": "Div(content-wrapper){\n    If(#notific_id#>0){\n        DBFind(@1notifications).WhereId(#notific_id#).Columns(\"id,page_params->decision_errand_id,page_params->type,processing_info,closed\").Vars(check_decisions)\n        If(And(#check_decisions_page_params_type# == task_decision,#check_decisions_page_params_decision_errand_id# != \"\")){\n            SetVar(errand_id,#check_decisions_page_params_decision_errand_id#)\n        }.Else{\n            SetVar(errand_id,#notific_id#)\n        }\n    }.ElseIf(#errand_id#>0){\n        SetVar(errand_id,#errand_id#)\n    }\n\n    DBFind(@1notifications).Where({\"ecosystem\": #ecosystem_id#, \"id\": #errand_id#}).Columns(\"id,page_params->name,sender->role_id,sender->role_name,sender->image_id,recipient->role_id,recipient->role_name,recipient->image_id,recipient->member_id,recipient->member_name,page_params->status,page_params->date_end,date_created,page_params->text,page_params->answer,processing_info,processing_info->member_id,processing_info->member_name,processing_info->image_id,closed\").Vars(prefix)\n\n    Form(row){\n        Div(col-md-6 col-md-offset-3){\n            Div(list-group-item text-center){\n                Span(Class: text-bold h4, Body: #prefix_page_params_name#)\n            }\n            Div(list-group-item){\n                Div(row){\n                    Div(col-md-5 mt-sm text-right){\n                        Button(Class: btn-link text-primary h5 text-bold, Page: @1roles_view, PageParams: \"v_role_id=#prefix_sender_role_id#\"){\n                            If(#prefix_sender_image_id#>0){\n                                Image(Src: Binary().ById(#sender.image_id#), Class: mr-sm).Style(width: 30px; border: 1px solid #5A5D63;)\n                                #prefix_sender_role_name#\n                            }.Else{\n                                Div(){\n                                    Span(Class: icon-people fa-2x mr-sm).(#prefix_sender_role_name#).Style(word-break: break-all;)\n                                }.Style(display:flex; align-items:center;)\n                            }\n                        }\n                    }\n                    Div(col-md-2 mt-sm text-center){\n                        Em(Class: fa fa-long-arrow-right text-muted fa-2x)\n                    }.Style(padding-top:12px;)\n                    Div(col-md-5 mt-sm text-left){\n                        If(#prefix_recipient_role_id# > 0){\n                            Button(Class: btn-link text-primary h5 text-bold, Page: @1roles_view, PageParams: \"v_role_id=#prefix_recipient_role_id#\"){\n                                If(#prefix_recipient_image_id#>0){\n                                    Image(Src: Binary().ById(#sender.image_id#), Class: mr-sm).Style(width: 30px; border: 1px solid #5A5D63;)\n                                    Span(#prefix_recipient_role_name#).Style(word-break: break-all;)\n                                }.Else{\n                                    Div(){\n                                        Span(Class: icon-people fa-2x mr-sm).(#prefix_recipient_role_name#).Style(word-break: break-all;)\n                                    }.Style(display:flex; align-items:center;)\n                                }\n                            }\n                        }.ElseIf(#prefix_recipient_member_id# != 0){\n                            Button(Class: btn-link text-primary h5 text-bold, Page: @1profile_view, PageParams: \"v_key_id=#prefix_recipient_member_id#\"){\n                                If(#prefix_recipient_image_id#>0){\n                                    Image(Src: Binary().ById(#prefix_recipient_image_id#), Class: img-circle).Style(height: 30px;width: 30px; border: 1px solid #5A5D63; margin-right: 10px;)\n                                    Span(#prefix_recipient_member_name#)\n                                }.Else{\n                                    Div(){\n                                        Span(Em(Class: fa icon-user fa-2x)).Style(margin-right:10px;)\n                                        Span(#prefix_recipient_member_name#).Style(word-break: break-all;)\n                                    }.Style(display:flex; align-items:center;)\n                                }\n                            }\n                        }\n                    }\n                }\n                Div(row){\n                    Div(col-md-5 mt-sm text-right){\n                        Span(Class: h5, Body: $@1status$)\n                    }\n                    Div(col-md-2 text-center)\n                    Div(col-md-5 mt-sm text-left){\n                        If(#prefix_page_params_status# == 0){\n                            Span(Body:Em(Class:fa fa-hourglass-half) $@1in_progress$, Class: text-primary h5)\n                        }.ElseIf(#prefix_page_params_status# == -1){\n                            Span(Body:Em(Class:fa fa-times) $@1expired$, Class: text-danger h5)\n                        }.ElseIf(#prefix_page_params_status# == 1){\n                            Span(Body:Em(Class:fa fa-hourglass-end) $@1done$, Class: text-success h5)\n                        }\n                    }\n                }\n                Div(row){\n                    Div(col-md-5 mt-sm text-right){\n                        Span(Class: h5, Body: $@1date_start$)\n                    }\n                    Div(col-md-2 mt-sm text-center)\n                    Div(col-md-5 mt-sm text-left){\n                        Span(Class: h5){DateTime(DateTime: #prefix_date_created#, Format: \"YYYY.MM.DD HH:MI:SS\")}\n                    }\n                }\n                Div(row){\n                    Div(col-md-5 mt-sm text-right){\n                        Span(Class: h5, Body: $@1date_end$)\n                    }\n                    Div(col-md-2 mt-sm text-center)\n                    Div(col-md-5 mt-sm text-left){\n                        Span(#prefix_page_params_date_end#,Class: h5)\n                    }\n                }\n                If(And(#prefix_processing_info# != \"\",#prefix_recipient_role_id# > 0)){\n                    Div(row){\n                        Div(col-md-5 mt-sm text-right){\n                            Span(Class: h5, Body: $@1performer_from_role$)\n                        }\n                        Div(col-md-2 mt-sm text-center)\n                        Div(col-md-5 mt-sm text-left){\n                            LinkPage(Class: text-primary h5 text-bold, Page: @1profile_view, PageParams: \"v_key_id=#prefix_processing_info_member_id#\"){\n                                Span(#prefix_processing_info_member_name#)\n                            }\n                        }\n                    }\n                }\n            }\n            Div(list-group-item){\n                Div(row){\n                    Div(col-md-12){\n                        Span(Class: h5 text-bold, Body: $@1errand_text$)\n                        Div(list-group-item){\n                            Span(Class: h5, Body: #prefix_page_params_text#)\n                        }\n                    }\n                }\n                If(Or(#prefix_recipient_member_id# == #key_id#,#prefix_processing_info_member_id# == #key_id#)){\n                    Div(row){\n                        Div(col-md-12){\n                            Span(Class: h5 text-bold, Body: $@1answer$)\n                            If(#prefix_page_params_status# == 0){\n                                Input(Name: answer_recipient, Type: textarea)\n                            }.Else{\n                                Div(list-group-item){\n                                    Span(Class: h5, Body: #prefix_page_params_answer#)\n                                }\n                            }\n                        }\n                    }.Style(padding-top:15px;)\n                }.Else{\n                    If(#prefix_page_params_answer# != \"\"){\n                        Div(row){\n                            Div(col-md-12){\n                                Span(Class: h5, Body: $@1answer$)\n                                Div(list-group-item){\n                                    Span(Class: h5, Body: #prefix_page_params_answer#)\n                                }\n                            }\n                        }.Style(padding-top:15px;)\n                    }\n                }\n            }\n            Div(list-group-item text-right){\n                If(Or(#prefix_recipient_role_id# == #role_id#, #prefix_recipient_member_id# == #key_id#)){\n                    If(#prefix_page_params_status# == 0){\n                        If(Or(#prefix_recipient_member_id# == #key_id#, #prefix_processing_info_member_id# == #key_id#)){\n                            Button($@1denial$, Class: btn btn-danger pull-left, Page: @1errand_list, PageParams: \"type=#type#\", Contract: @1ErrandDecision, Params: \"errand_id=#errand_id#,errand_decision=-1\")\n                            Button($@1done$, Class: btn btn-success, Page: @1errand_list, PageParams: \"type=#type#\", Contract: @1ErrandDecision, Params: \"errand_id=#errand_id#,errand_decision=1\")\n                        }.ElseIf(And(#prefix_recipient_role_id# > 0, #prefix_processing_info# == \"\")){\n                            If(#notific_id# > 0){\n                                Button($@1back$, Class: btn btn-default, Page: @1notifications_list)\n                            }.Else{\n                                Button($@1back$, Class: btn btn-default, Page: @1errand_list, PageParams: \"type=#type#\")\n                            }\n                            Button($@1start_process$, Class: btn btn-primary, Page: @1errand_view, PageParams: \"notific_id=#errand_id#\", Contract: @1NotificationsProcess, Params: \"notific_id=#errand_id#\")\n                        }\n                    }.ElseIf(#errand_id# > 0){\n                        If(#notific_id# > 0){\n                            DBFind(@1notifications).Where({\"ecosystem\": #ecosystem_id#, \"id\": #notific_id#}).Vars(cl)\n                        }\n                        If(#cl_closed# == 0){\n                            If(#cl_processing_info# == \"\"){\n                                Button($@1start_process$,Class: btn btn-primary, Page: @1errand_view, PageParams: \"notific_id=#notific_id#\", Contract: @1NotificationsProcess, Params: \"notific_id=#notific_id#\")\n                            }.Else{\n                                Button($@1close$, Class: btn btn-default, Page: @1notifications_list, Contract: @1NotificationsClose,Params: \"notific_id=#notific_id#\")\n                            }\n                        }.Else{\n                            Button($@1back$, Class: btn btn-default, Page: @1errand_list, PageParams: \"type=#type#\")\n                        }\n                    }\n                }.Else{\n                    If(#check_decisions_closed# == 0){\n                        If(#check_decisions_processing_info# == \"\"){\n                            Button($@1start_process$, Class: btn btn-primary, Page: @1errand_view, PageParams: \"notific_id=#notific_id#\", Contract: @1NotificationsProcess, Params: \"notific_id=#notific_id#\")\n                        }.Else{\n                            Button($@1close$, Class: btn btn-default, Page: @1notifications_list, Contract: @1NotificationsClose, Params: \"notific_id=#notific_id#\")\n                        }\n                    }.Else{\n                        If(#notific_id# > 0){\n                            Button($@1back$, Class: btn btn-default, Page: @1notifications_list, PageParams: \"type=#type#\")\n                        }.Else{\n                            Button($@1back$, Class: btn btn-default, Page: @1errand_list, PageParams: \"type=#type#\")\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n",
=======
            "Value": "Div(content-wrapper){\n    If(#notific_id#>0){\n        DBFind(@1notifications).WhereId(#notific_id#).Columns(\"id,page_params->decision_errand_id,page_params->type,processing_info,closed\").Vars(check_decisions)\n        If(And(#check_decisions_page_params_type# == task_decision,#check_decisions_page_params_decision_errand_id# != \"\")){\n            SetVar(errand_id,#check_decisions_page_params_decision_errand_id#)\n        }.Else{\n            SetVar(errand_id,#notific_id#)\n        }\n    }.ElseIf(#errand_id#>0){\n        SetVar(errand_id,#errand_id#)\n    }\n\n    DBFind(@1notifications).Where({\"ecosystem\": #ecosystem_id#, \"id\": #errand_id#}).Columns(\"id,page_params->name,sender->role_id,sender->role_name,sender->image_id,recipient->role_id,recipient->role_name,recipient->image_id,recipient->member_id,recipient->member_name,page_params->status,page_params->date_end,date_created,page_params->text,page_params->answer,processing_info,processing_info->member_id,processing_info->member_name,processing_info->image_id,closed\").Vars(prefix)\n    \n    Form(row){\n        Div(col-md-6 col-md-offset-3){\n            Div(list-group-item text-center){\n                Span(Class: text-bold h4, Body: #prefix_page_params_name#)\n            }\n            Div(list-group-item){\n                Div(row){\n                    Div(col-md-5 mt-sm text-right){\n                        Button(Class: btn-link text-primary h5 text-bold, Page: @1roles_view, PageParams: \"v_role_id=#prefix_sender_role_id#\"){\n                            If(#prefix_sender_image_id#>0){\n                                Image(Src: Binary().ById(#sender.image_id#), Class: mr-sm).Style(width: 30px; border: 1px solid #5A5D63;)\n                                #prefix_sender_role_name#\n                            }.Else{\n                                Div(){\n                                    Span(Class: icon-people fa-2x mr-sm).(#prefix_sender_role_name#).Style(word-break: break-all;)\n                                }.Style(display:flex; align-items:center;)\n                            }\n                        }\n                    }\n                    Div(col-md-2 mt-sm text-center){\n                        Em(Class: fa fa-long-arrow-right text-muted fa-2x)\n                    }.Style(padding-top:12px;)\n                    Div(col-md-5 mt-sm text-left){\n                        If(#prefix_recipient_role_id# > 0){\n                            Button(Class: btn-link text-primary h5 text-bold, Page: @1roles_view, PageParams: \"v_role_id=#prefix_recipient_role_id#\"){\n                                If(#prefix_recipient_image_id#>0){\n                                    Image(Src: Binary().ById(#sender.image_id#), Class: mr-sm).Style(width: 30px; border: 1px solid #5A5D63;)\n                                    Span(#prefix_recipient_role_name#).Style(word-break: break-all;)\n                                }.Else{\n                                    Div(){\n                                        Span(Class: icon-people fa-2x mr-sm).(#prefix_recipient_role_name#).Style(word-break: break-all;)\n                                    }.Style(display:flex; align-items:center;)\n                                }\n                            }\n                        }.ElseIf(#prefix_recipient_member_id# != 0){\n                            Button(Class: btn-link text-primary h5 text-bold, Page: @1profile_view, PageParams: \"v_key_id=#prefix_recipient_member_id#\"){\n                                If(#prefix_recipient_image_id#>0){\n                                    Image(Src: Binary().ById(#prefix_recipient_image_id#), Class: img-circle).Style(height: 30px;width: 30px; border: 1px solid #5A5D63; margin-right: 10px;)\n                                    Span(#prefix_recipient_member_name#)\n                                }.Else{\n                                    Div(){\n                                        Span(Em(Class: fa icon-user fa-2x)).Style(margin-right:10px;)\n                                        Span(#prefix_recipient_member_name#).Style(word-break: break-all;)\n                                    }.Style(display:flex; align-items:center;)\n                                }\n                            }\n                        }   \n                    }\n                }\n                Div(row){\n                    Div(col-md-5 mt-sm text-right){\n                        Span(Class: h5, Body: $@1status$)\n                    }\n                    Div(col-md-2 text-center)\n                    Div(col-md-5 mt-sm text-left){\n                        If(#prefix_page_params_status# == 0){\n                            Span(Body:Em(Class:fa fa-hourglass-half) $@1in_progress$, Class: text-primary h5)\n                        }.ElseIf(#prefix_page_params_status# == -1){\n                            Span(Body:Em(Class:fa fa-times) $@1expired$, Class: text-danger h5)\n                        }.ElseIf(#prefix_page_params_status# == 1){\n                            Span(Body:Em(Class:fa fa-hourglass-end) $@1done$, Class: text-success h5)\n                        }\n                    }\n                }\n                Div(row){\n                    Div(col-md-5 mt-sm text-right){\n                        Span(Class: h5, Body: $@1date_start$)\n                    }\n                    Div(col-md-2 mt-sm text-center)\n                    Div(col-md-5 mt-sm text-left){\n                        Span(Class: h5){DateTime(DateTime: #prefix_date_created#, Format: \"YYYY.MM.DD HH:MI:SS\")}\n                    }\n                }\n                Div(row){\n                    Div(col-md-5 mt-sm text-right){\n                        Span(Class: h5, Body: $@1date_end$)\n                    }\n                    Div(col-md-2 mt-sm text-center)\n                    Div(col-md-5 mt-sm text-left){\n                        Span(#prefix_page_params_date_end#,Class: h5)\n                    }\n                }\n                If(And(#prefix_processing_info# != \"\",#prefix_recipient_role_id# > 0)){\n                    Div(row){\n                        Div(col-md-5 mt-sm text-right){\n                            Span(Class: h5, Body: $@1performer_from_role$)\n                        }\n                        Div(col-md-2 mt-sm text-center)\n                        Div(col-md-5 mt-sm text-left){\n                            LinkPage(Class: text-primary h5 text-bold, Page: @1profile_view, PageParams: \"v_key_id=#prefix_processing_info_member_id#\"){\n                                Span(#prefix_processing_info_member_name#)\n                            }\n                        }\n                    }\n                }\n            }\n            Div(list-group-item){\n                Div(row){\n                    Div(col-md-12){\n                        Span(Class: h5 text-bold, Body: $@1errand_text$)\n                        Div(list-group-item){\n                            Span(Class: h5, Body: #prefix_page_params_text#)\n                        }\n                    }\n                }\n                If(Or(#prefix_recipient_member_id# == #key_id#,#prefix_processing_info_member_id# == #key_id#)){\n                    Div(row){\n                        Div(col-md-12){\n                            Span(Class: h5 text-bold, Body: $@1answer$)\n                            If(#prefix_page_params_status# == 0){\n                                Input(Name: AnswerRecipient, Type: textarea)\n                            }.Else{\n                                Div(list-group-item){\n                                    Span(Class: h5, Body: #prefix_page_params_answer#)\n                                }\n                            }\n                        }\n                    }.Style(padding-top:15px;)\n                }.Else{\n                    If(#prefix_page_params_answer# != \"\"){\n                        Div(row){\n                            Div(col-md-12){\n                                Span(Class: h5, Body: $@1answer$)\n                                Div(list-group-item){\n                                    Span(Class: h5, Body: #prefix_page_params_answer#)\n                                }\n                            }\n                        }.Style(padding-top:15px;)\n                    }\n                }\n            }\n            Div(list-group-item text-right){\n                If(Or(#prefix_recipient_role_id# == #role_id#, #prefix_recipient_member_id# == #key_id#)){\n                    If(#prefix_page_params_status# == 0){\n                        If(Or(#prefix_recipient_member_id# == #key_id#, #prefix_processing_info_member_id# == #key_id#)){\n                            Button($@1denial$, Class: btn btn-danger pull-left, Page: @1errand_list, PageParams: \"type=#type#\", Contract: @1ErrandDecision, Params: \"ErrandId=#errand_id#,ErrandDecision=-1\")\n                            Button($@1done$, Class: btn btn-success, Page: @1errand_list, PageParams: \"type=#type#\", Contract: @1ErrandDecision, Params: \"ErrandId=#errand_id#,ErrandDecision=1\")\n                        }.ElseIf(And(#prefix_recipient_role_id# > 0, #prefix_processing_info# == \"\")){\n                            If(#notific_id# > 0){\n                                Button($@1back$, Class: btn btn-default, Page: @1notifications_list)\n                            }.Else{\n                                Button($@1back$, Class: btn btn-default, Page: @1errand_list, PageParams: \"type=#type#\")\n                            }\n                            Button($@1start_process$, Class: btn btn-primary, Page: @1errand_view, PageParams: \"notific_id=#errand_id#\", Contract: @1NotificationsProcess, Params: \"notific_id=#errand_id#\")\n                        }\n                    }.ElseIf(#errand_id# > 0){\n                        If(#notific_id# > 0){\n                            DBFind(@1notifications).Where({\"ecosystem\": #ecosystem_id#, \"id\": #notific_id#}).Vars(cl)\n                        }\n                        If(#cl_closed# == 0){\n                            If(#cl_processing_info# == \"\"){\n                                Button($@1start_process$,Class: btn btn-primary, Page: @1errand_view, PageParams: \"notific_id=#notific_id#\", Contract: @1NotificationsProcess, Params: \"notific_id=#notific_id#\")\n                            }.Else{\n                                Button($@1close$, Class: btn btn-default, Page: @1notifications_list, Contract: @1NotificationsClose, Params: \"notific_id=#notific_id#\")\n                            }\n                        }.Else{\n                            Button($@1back$, Class: btn btn-default, Page: @1errand_list, PageParams: \"type=#type#\")\n                        }\n                    }\n                }.Else{\n                    If(#check_decisions_closed# == 0){\n                        If(#check_decisions_processing_info# == \"\"){\n                            Button($@1start_process$, Class: btn btn-primary, Page: @1errand_view, PageParams: \"notific_id=#notific_id#\", Contract: @1NotificationsProcess, Params: \"notific_id=#notific_id#\")\n                        }.Else{\n                            Button($@1close$, Class: btn btn-default, Page: @1notifications_list, Contract: @1NotificationsClose, Params: \"notific_id=#notific_id#\")\n                        }\n                    }.Else{\n                        If(#notific_id# > 0){\n                            Button($@1back$, Class: btn btn-default, Page: @1notifications_list, PageParams: \"type=#type#\") \n                        }.Else{\n                            Button($@1back$, Class: btn btn-default, Page: @1errand_list, PageParams: \"type=#type#\") \n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n",
>>>>>>> AA-687
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "ErrandCreate",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
<<<<<<< HEAD
            "Value": "contract ErrandCreate {\n    data {\n        errand_type int\n        rec_role_id int \"optional\"\n        send_role_id int\n        member_id string \"optional\"\n        errand_name string\n        errand_text string\n        role_type_errand int \"optional\"\n\n        end_date string\n        end_time string \"optional\"\n    }\n\n    func isCalledFromPage() bool {\n        return $stack[0] == Sprintf(\"@%v%v\", $ecosystem_id, $this_contract)\n    }\n\n    func trimZeroTime(s string) string {\n        if Contains(s, \"T00:00:00Z\") {\n            s = s Replace(s, \"T00:00:00Z\", \"\")\n        }\n        return s\n    }\n\n    func dateAddTime(d, t string) string {\n        var dt string\n        if Size(t) == 5 {\n            dt = Sprintf(\"%v %v:00\", trimZeroTime(d), t)\n        }\n        return dt\n    }\n\n    func fixDatetimes() {\n        $date_ended = dateAddTime($end_date, $end_time)\n\n        if UnixDateTime($date_ended) == 0 { // invalid datetimes\n            if isCalledFromPage(){\n                var errs array\n                if Size($end_date) < 10 {\n                    error LangRes(\"@1ending_date_invalid\", \"en\")\n                }\n                if Size($end_time) < 5 {\n                    error LangRes(\"@1invalid_time_end\", \"en\")\n                }\n            }\n        }\n        if UnixDateTime($date_ended) < $block_time{\n            error LangRes(\"@1starting_date_invalid\", \"en\")\n        }\n    }\n\n    conditions {\n        $app = DBFind(\"@1applications\").Where({\"ecosystem\": $ecosystem_id, \"name\": \"Errands\"}).One(\"id\")\n        $check_access = AppParam(Int($app), \"errands_access\", $ecosystem_id)\n        if $check_access {\n            var rids array\n            rids = JSONDecode(\"[\"+$check_access+\"]\")\n            if !DBFind(\"@1roles_participants\").Where({\"ecosystem\": $ecosystem_id, \"role->id\": {\"$in\": rids}, \"member->member_id\": $key_id, \"deleted\": 0}).Row() {\n                warning LangRes(\"@1access_denied\", \"en\")\n            }\n        } else {\n            var admin_ids int\n            admin_ids = AppParam(Int($app), \"errands_admin_role\", $ecosystem_id)\n            var rids array\n            rids = JSONDecode(\"[\"+admin_ids+\"]\")\n            if !DBFind(\"@1roles_participants\").Where({\"ecosystem\": $ecosystem_id, \"role->id\": {\"$in\": rids}, \"member->member_id\": $key_id, \"deleted\": 0}).Row() {\n                warning LangRes(\"@1access_denied\", \"en\")\n            }\n        }\n        if $errand_type == 0 {\n            $valid_role = DBFind(\"@1roles\").Where({\"ecosystem\": $ecosystem_id, \"id\": $rec_role_id, \"deleted\": 0}).One(\"id\")\n            if $valid_role == 0 {\n                info LangRes(\"@1role_not_found\", \"en\")\n            }\n        }\n        if $errand_type == 1 {\n            if $member_id == \"\" {\n                info LangRes(\"@1empty_wallet\", \"en\")\n            }\n            $member_id = AddressToId($member_id)\n            $check_member = DBFind(\"@1members\").Where({\"id\": $member_id, \"ecosystem\": $ecosystem_id}).One(\"id\")\n            if (Int($check_member) == 0){\n                if !DBFind(\"@1keys\").Where({\"ecosystem\": $ecosystem_id, \"id\": $member_id}).Columns(\"id\").Row() {\n                    error LangRes(\"@1member_not_found\", \"en\")\n                }\n            }\n            if $end_date == \"\" {\n                info LangRes(\"@1ending_date_invalid\", \"en\")\n            }\n            if $end_time == \"\" {\n                info LangRes(\"@1invalid_time_end\", \"en\")\n            }\n            if $errand_name == \"\" {\n                info LangRes(\"@1empty_name\", \"en\")\n            }\n            if $errand_text == \"\" {\n                info LangRes(\"@1empty_text\", \"en\")\n            }\n            }\n        fixDatetimes()\n    }\n\n    action {\n        var info_errand map\n\n        info_errand[\"name\"] = $errand_name\n        info_errand[\"text\"] = $errand_text\n        info_errand[\"date_end\"] = $date_ended\n        info_errand[\"status\"] = 0\n        info_errand[\"type\"] = \"task\"\n        if $errand_type == 0 {\n            if $role_type_errand == 2 {\n                info_errand[\"recipient_type\"] = 1\n            } else{\n                info_errand[\"recipient_type\"] = 0\n            }\n        }\n        if $errand_type == 1 {\n            info_errand[\"recipient_type\"] = 1\n        }\n\n        if $errand_type == 0 {\n            if $role_type_errand == 2 {\n                var errands array i lenErrands member_r_id int v map\n                errands = DBFind(\"@1roles_participants\").Columns(\"id,role->id,member->member_id,ecosystem,deleted\").Where({\"role->id\": $rec_role_id, \"deleted\": 0, \"ecosystem\": $ecosystem_id})\n                lenErrands = Len(errands)\n                if lenErrands == 0 {\n                    info(LangRes(\"@1recipient_role_no_members\", \"en\"))\n                }\n                while i < lenErrands{\n                    v = errands[i]\n                    member_r_id = Int(v[\"member.member_id\"])\n                    @1NotificationsSend(\"current_role_id,member_id,sender,icon_name,text_header,text_body,page_name,params_map,rid,closure_type,eco_id\",$send_role_id,member_r_id, 2, \"icon icon-envelope-open\", LangRes(\"@1new_errand\", \"en\"), LangRes(\"@1details_view\", \"en\"), \"@1errand_view\", info_errand, 0, 0,$ecosystem_id)\n                    i = i + 1\n                }\n            } else {\n                @1NotificationsSend(\"current_role_id,rid,sender,icon_name,text_header,text_body,page_name,params_map,closure_type,eco_id\",$send_role_id,$rec_role_id, 2, \"icon icon-envelope-open\", LangRes(\"@1new_errand\", \"en\"), LangRes(\"@1details_view\", \"en\"), \"@1errand_view\",info_errand,1,$ecosystem_id)\n            }\n        }\n        if $errand_type == 1 {\n            @1NotificationsSend(\"current_role_id,member_id,sender,icon_name,text_header,text_body,page_name,params_map,rid,closure_type,eco_id\",$send_role_id,Int($member_id), 2, \"icon icon-envelope-open\", LangRes(\"@1new_errand\", \"en\"), LangRes(\"@1details_view\", \"en\"), \"@1errand_view\", info_errand, 0, 0,$ecosystem_id)\n        }\n    }\n}",
=======
            "Value": "contract ErrandCreate {\n    data {\n        ErrandType int\n        RecRoleId int \"optional\"\n        SendRoleId int\n        MemberId string \"optional\"\n        ErrandName string\n        ErrandText string\n        RoleTypeErrand int \"optional\"\n\n        end_date string\n        end_time string \"optional\"\n    }\n\n    func isCalledFromPage() bool {\n        return $stack[0] == Sprintf(\"@%v%v\", $ecosystem_id, $this_contract)\n    }\n\n    func trimZeroTime(s string) string {\n        if Contains(s, \"T00:00:00Z\") {\n            s = s Replace(s, \"T00:00:00Z\", \"\")\n        }\n        return s\n    }\n\n    func dateAddTime(d, t string) string {\n        var dt string\n        if Size(t) == 5 {\n            dt = Sprintf(\"%v %v:00\", trimZeroTime(d), t)\n        }\n        return dt\n    }\n\n    func fixDatetimes() {\n        $date_ended = dateAddTime($end_date, $end_time)\n\n        if UnixDateTime($date_ended) == 0 { // invalid datetimes\n            if isCalledFromPage(){\n                var errs array\n                if Size($end_date) < 10 {\n                    error LangRes(\"@1ending_date_invalid\", \"en\")\n                }\n                if Size($end_time) < 5 {\n                    error LangRes(\"@1invalid_time_end\", \"en\")\n                }\n            }\n        }\n        if UnixDateTime($date_ended) < $block_time{\n            error LangRes(\"@1starting_date_invalid\", \"en\")\n        }\n    }\n\n    conditions {\n        $app = DBFind(\"@1applications\").Where({\"ecosystem\": $ecosystem_id, \"name\": \"Errands\"}).One(\"id\")\n        $check_access = AppParam(Int($app), \"errands_access\", $ecosystem_id)\n        if $check_access {\n            var rids array\n            rids = JSONDecode(\"[\"+$check_access+\"]\")\n            if !DBFind(\"@1roles_participants\").Where({\"ecosystem\": $ecosystem_id, \"role->id\": {\"$in\": rids}, \"member->member_id\": $key_id, \"deleted\": 0}).Row() {\n                warning LangRes(\"@1access_denied\", \"en\")\n            }\n        } else {\n            var admin_ids int\n            admin_ids = AppParam(Int($app), \"errands_admin_role\", $ecosystem_id)\n            var rids array\n            rids = JSONDecode(\"[\"+admin_ids+\"]\")  \n            if !DBFind(\"@1roles_participants\").Where({\"ecosystem\": $ecosystem_id, \"role->id\": {\"$in\": rids}, \"member->member_id\": $key_id, \"deleted\": 0}).Row() {\n                warning LangRes(\"@1access_denied\", \"en\")\n            }\n        }\n        if $ErrandType == 0 {\n            $valid_role = DBFind(\"@1roles\").Where({\"ecosystem\": $ecosystem_id, \"id\": $RecRoleId, \"deleted\": 0}).One(\"id\")\n            if $valid_role == 0 {\n                info LangRes(\"@1role_not_found\", \"en\")\n            }\n        }\n        if $ErrandType == 1 {\n            if $MemberId == \"\" {\n                info LangRes(\"@1empty_wallet\", \"en\")\n            }\n            $MemberId = AddressToId($MemberId)\n            $check_member = DBFind(\"@1members\").Where({\"id\": $MemberId, \"ecosystem\": $ecosystem_id}).One(\"id\")\n            if (Int($check_member) == 0){\n                if !DBFind(\"@1keys\").Where({\"ecosystem\": $ecosystem_id, \"id\": $MemberId}).Columns(\"id\").Row() {\n                    error LangRes(\"@1member_not_found\", \"en\")\n                }\n            }\n            if $end_date == \"\" {\n                info LangRes(\"@1ending_date_invalid\", \"en\")\n            }\n            if $end_time == \"\" {\n                info LangRes(\"@1invalid_time_end\", \"en\")\n            }\n            if $ErrandName == \"\" {\n                info LangRes(\"@1empty_name\", \"en\")\n            }\n            if $ErrandText == \"\" {\n                info LangRes(\"@1empty_text\", \"en\")\n            }\n            }\n        fixDatetimes()\n    }\n\n    action {\n        var info_errand map\n\n        info_errand[\"name\"] = $ErrandName\n        info_errand[\"text\"] = $ErrandText\n        info_errand[\"date_end\"] = $date_ended\n        info_errand[\"status\"] = 0\n        info_errand[\"type\"] = \"task\"\n        if $ErrandType == 0 {\n            if $RoleTypeErrand == 2 {\n                info_errand[\"recipient_type\"] = 1\n            } else{\n                info_errand[\"recipient_type\"] = 0\n            }\n        }\n        if $ErrandType == 1 {\n            info_errand[\"recipient_type\"] = 1\n        }\n\n        if $ErrandType == 0 {\n            if $RoleTypeErrand == 2 {\n                var errands array i lenErrands member_r_id int v map\n                errands = DBFind(\"@1roles_participants\").Columns(\"id,role->id,member->member_id,ecosystem,deleted\").Where({\"role->id\": $RecRoleId, \"deleted\": 0, \"ecosystem\": $ecosystem_id})\n                lenErrands = Len(errands)\n                if lenErrands == 0 {\n                    info(LangRes(\"@1recipient_role_no_members\", \"en\"))\n                }\n                while i < lenErrands{\n                    v = errands[i]\n                    member_r_id = Int(v[\"member.member_id\"])\n                    @1NotificationsSend(\"current_role_id,member_id,sender,icon_name,text_header,text_body,page_name,params_map,rid,closure_type,eco_id\",$SendRoleId,member_r_id, 2, \"icon icon-envelope-open\", LangRes(\"@1new_errand\", \"en\"), LangRes(\"@1details_view\", \"en\"), \"@1errand_view\", info_errand, 0, 0,$ecosystem_id)\n                    i = i + 1\n                }\n            } else { \n                @1NotificationsSend(\"current_role_id,rid,sender,icon_name,text_header,text_body,page_name,params_map,closure_type,eco_id\",$SendRoleId,$RecRoleId, 2, \"icon icon-envelope-open\", LangRes(\"@1new_errand\", \"en\"), LangRes(\"@1details_view\", \"en\"), \"@1errand_view\",info_errand,1,$ecosystem_id)\n            }\n        }\n        if $ErrandType == 1 {\n            @1NotificationsSend(\"current_role_id,member_id,sender,icon_name,text_header,text_body,page_name,params_map,rid,closure_type,eco_id\",$SendRoleId,Int($MemberId), 2, \"icon icon-envelope-open\", LangRes(\"@1new_errand\", \"en\"), LangRes(\"@1details_view\", \"en\"), \"@1errand_view\", info_errand, 0, 0,$ecosystem_id)\n        }\n    }\n}",
>>>>>>> AA-687
            "Type": "contracts"
        },
        {
            "Name": "ErrandDecision",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
<<<<<<< HEAD
            "Value": "contract ErrandDecision {\n    data {\n        errand_decision int\n        errand_id int\n        answer_recipient string\n    }\n\n    conditions {\n        if $answer_recipient == \"\" {\n            info LangRes(\"@1empty_answer\", \"en\")\n        }\n        $errand_map = DBFind(\"@1notifications\").Where({\"id\": $errand_id}).Columns(\"id,processing_info,processing_info->member_id,page_params,page_params->name,page_params->text,page_params->type,page_params->date_end,closed,recipient->role_id,recipient->member_id,page_params->recipient_type,sender->role_id\").Row()\n        if Int($errand_map[\"page_params.recipient_type\"]) == 0 { //role errand\n            if !RoleAccess(Int($errand_map[\"recipient.role_id\"])) {\n                warning LangRes(\"@1access_denied\", \"en\")\n            }\n            if $errand_map[\"processing_info\"] == \"\" {\n                info LangRes(\"@1start_process_errand\", \"en\")\n            }\n            if Int($errand_map[\"processing_info.member_id\"]) != $key_id {\n                info LangRes(\"@1another_start_process_errand\", \"en\")\n            }\n        } else { //member errand\n            if Int($errand_map[\"recipient.member_id\"]) != $key_id {\n                warning LangRes(\"@1access_denied\", \"en\")\n            }\n        }\n        if $errand_map[\"closed\"] != 0 {\n            info LangRes(\"@1already_start_process_errand\", \"en\")\n        }\n    }\n\n    action {\n        var answer_map map\n        answer_map[\"name\"] = $errand_map[\"page_params.name\"]\n        answer_map[\"text\"] = $errand_map[\"page_params.text\"]\n        answer_map[\"type\"] = $errand_map[\"page_params.type\"]\n        answer_map[\"date_end\"] = $errand_map[\"page_params.date_end\"]\n        answer_map[\"answer\"] = $answer_recipient\n\n        if $errand_decision == 1 {\n            answer_map[\"status\"] = 1\n        } else {\n            answer_map[\"status\"] = -1\n        }\n        var page_params_edit map\n        page_params_edit[\"page_params\"] = answer_map\n\n        @1NotificationsUpdateParams(\"page_params,notific_id\",page_params_edit,$errand_id)\n\n        if Int($errand_map[\"page_params.recipient_type\"]) == 0 {\n            var info_errand map\n            info_errand[\"decision_errand_id\"] = $errand_id\n            info_errand[\"type\"] = \"task_decision\"\n            @1NotificationsSend(\"current_role_id,rid,sender,icon_name,text_header,text_body,page_name,params_map,closure_type,eco_id\",Int($errand_map[\"recipient.role_id\"]),Int($errand_map[\"sender.role_id\"]), 2, \"icon icon-envelope-open\", \"Decision by errand\", LangRes(\"@1details_view\", \"en\"), \"@1errand_view\",info_errand,1,$ecosystem_id)\n        }\n        else{\n            var info_errand map\n            info_errand[\"decision_errand_id\"] = $errand_id\n            info_errand[\"type\"] = \"task_decision\"\n            @1NotificationsSend(\"rid,sender,icon_name,text_header,text_body,page_name,params_map,closure_type,eco_id\",Int($errand_map[\"sender.role_id\"]), 1, \"icon icon-envelope-open\", \"Decision by errand\", LangRes(\"@1details_view\", \"en\"), \"@1errand_view\",info_errand,1,$ecosystem_id)\n        }\n        @1NotificationsClose(\"notific_id\", $errand_id)\n    }\n}",
=======
            "Value": "contract ErrandDecision {\n    data {\n        ErrandDecision int\n        ErrandId int\n        AnswerRecipient string\n    }\n\n    conditions {\n        if $AnswerRecipient == \"\" {\n            info LangRes(\"@1empty_answer\", \"en\")\n        }\n        $errand_map = DBFind(\"@1notifications\").Where({\"id\": $ErrandId}).Columns(\"id,processing_info,processing_info->member_id,page_params,page_params->name,page_params->text,page_params->type,page_params->date_end,closed,recipient->role_id,recipient->member_id,page_params->recipient_type,sender->role_id\").Row()\n        if Int($errand_map[\"page_params.recipient_type\"]) == 0 { //role errand\n            if !RoleAccess(Int($errand_map[\"recipient.role_id\"])) {\n                warning LangRes(\"@1access_denied\", \"en\")\n            }\n            if $errand_map[\"processing_info\"] == \"\" {\n                info LangRes(\"@1start_process_errand\", \"en\")\n            }\n            if Int($errand_map[\"processing_info.member_id\"]) != $key_id {\n                info LangRes(\"@1another_start_process_errand\", \"en\")\n            }\n        } else { //member errand\n            if Int($errand_map[\"recipient.member_id\"]) != $key_id {\n                warning LangRes(\"@1access_denied\", \"en\")\n            }\n        }\n        if $errand_map[\"closed\"] != 0 {\n            info LangRes(\"@1already_start_process_errand\", \"en\")\n        }\n    }\n\n    action {\n        var answer_map map\n        answer_map[\"name\"] = $errand_map[\"page_params.name\"]\n        answer_map[\"text\"] = $errand_map[\"page_params.text\"]\n        answer_map[\"type\"] = $errand_map[\"page_params.type\"]\n        answer_map[\"date_end\"] = $errand_map[\"page_params.date_end\"]\n        answer_map[\"answer\"] = $AnswerRecipient\n        \n        if $ErrandDecision == 1 {\n            answer_map[\"status\"] = 1\n        } else {\n            answer_map[\"status\"] = -1\n        }\n        var page_params_edit map\n        page_params_edit[\"page_params\"] = answer_map\n       \n        @1NotificationsUpdateParams(\"page_params,notific_id\",page_params_edit,$ErrandId)\n        \n        if Int($errand_map[\"page_params.recipient_type\"]) == 0 {\n            var info_errand map\n            info_errand[\"decision_errand_id\"] = $ErrandId\n            info_errand[\"type\"] = \"task_decision\"\n            @1NotificationsSend(\"current_role_id,rid,sender,icon_name,text_header,text_body,page_name,params_map,closure_type,eco_id\",Int($errand_map[\"recipient.role_id\"]),Int($errand_map[\"sender.role_id\"]), 2, \"icon icon-envelope-open\", \"Decision by errand\", LangRes(\"@1details_view\", \"en\"), \"@1errand_view\",info_errand,1,$ecosystem_id)\n        }\n        else{\n            var info_errand map\n            info_errand[\"decision_errand_id\"] = $ErrandId\n            info_errand[\"type\"] = \"task_decision\"\n            @1NotificationsSend(\"rid,sender,icon_name,text_header,text_body,page_name,params_map,closure_type,eco_id\",Int($errand_map[\"sender.role_id\"]), 1, \"icon icon-envelope-open\", \"Decision by errand\", LangRes(\"@1details_view\", \"en\"), \"@1errand_view\",info_errand,1,$ecosystem_id)\n        }\n        @1NotificationsClose(\"notific_id\", $ErrandId) \n    }\n}",
>>>>>>> AA-687
            "Type": "contracts"
        },
        {
            "Name": "ErrandDelete",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
<<<<<<< HEAD
            "Value": "contract ErrandDelete {\n    data {\n        errand_id int\n    }\n\n    conditions {\n        $app = DBFind(\"@1applications\").Where({\"ecosystem\": $ecosystem_id, \"name\": \"Errands\"}).One(\"id\")\n        var admin_ids int\n        admin_ids = AppParam(Int($app), \"errands_admin_role\", $ecosystem_id)\n        var rids array\n        rids = JSONDecode(\"[\"+admin_ids+\"]\")\n        if !DBFind(\"@1roles_participants\").Where({\"ecosystem\": $ecosystem_id, \"role->id\": {\"$in\": rids}, \"member->member_id\": $key_id, \"deleted\": 0}).Row() {\n            warning LangRes(\"@1access_denied\", \"en\")\n        }\n    }\n\n    action {\n        var page_params_edit errand_map map\n        page_params_edit[\"page_params->type\"] = \"deleted\"\n\n        @1NotificationsUpdateParams(\"page_params,notific_id\",page_params_edit,$errand_id)\n        errand_map = DBFind(\"@1notifications\").Where({\"id\": $errand_id}).Columns(\"date_start_processing,page_params->recipient_type\").Row()\n        @1NotificationsClose(\"notific_id\", $errand_id)\n    }\n}",
=======
            "Value": "contract ErrandDelete {\n    data {\n        ErrandId int\n    }\n\n    conditions {\n        $app = DBFind(\"@1applications\").Where({\"ecosystem\": $ecosystem_id, \"name\": \"Errands\"}).One(\"id\")\n        var admin_ids int\n        admin_ids = AppParam(Int($app), \"errands_admin_role\", $ecosystem_id)\n        var rids array\n        rids = JSONDecode(\"[\"+admin_ids+\"]\")  \n        if !DBFind(\"@1roles_participants\").Where({\"ecosystem\": $ecosystem_id, \"role->id\": {\"$in\": rids}, \"member->member_id\": $key_id, \"deleted\": 0}).Row() {\n            warning LangRes(\"@1access_denied\", \"en\")\n        }\n    }\n\n    action {\n        var page_params_edit errand_map map\n        page_params_edit[\"page_params->type\"] = \"deleted\"\n        \n        @1NotificationsUpdateParams(\"page_params,notific_id\",page_params_edit,$ErrandId)\n        errand_map = DBFind(\"@1notifications\").Where({\"id\": $ErrandId}).Columns(\"date_start_processing,page_params->recipient_type\").Row()\n        @1NotificationsClose(\"notific_id\", $ErrandId)\n    }\n}",
>>>>>>> AA-687
            "Type": "contracts"
        },
        {
            "Name": "ErrandStatusUpdate",
            "Conditions": "ContractConditions(\"@1DeveloperCondition\")",
            "Value": "contract ErrandStatusUpdate {\n    conditions {\n        $app = DBFind(\"@1applications\").Where({\"ecosystem\": $ecosystem_id, \"name\": \"Errands\"}).One(\"id\")\n        var admin_ids int\n        admin_ids = AppParam(Int($app), \"errands_admin_role\", $ecosystem_id)\n        var rids array\n        rids = JSONDecode(\"[\"+admin_ids+\"]\")\n        if !DBFind(\"@1roles_participants\").Where({\"ecosystem\": $ecosystem_id, \"role->id\": {\"$in\": rids}, \"member->member_id\": $key_id, \"deleted\": 0}).Row() {\n            warning LangRes(\"@1access_denied\", \"en\")\n        }\n    }\n\n    action {\n        var bt string\n        bt = BlockTime()\n\n        var errands array i lenErrands int v page_params_edit map\n        errands = DBFind(\"@1notifications\").Columns(\"id,page_params->date_end,page_params->type,page_params->status\").Where({\"page_params->type\": \"task\", \"page_params->date_end\": {\"$lte\": bt}, \"page_params->status\": 0})\n        lenErrands = Len(errands)\n        page_params_edit[\"page_params->status\"] = -1\n        while i < lenErrands{\n            v = errands[i]\n            @1NotificationsUpdateParams(\"page_params,notific_id\", page_params_edit, Int(v[\"id\"]))\n            i = i + 1\n        }\n    }\n}",
            "Type": "contracts"
        }
    ]
}