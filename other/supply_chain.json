{
    "blocks": [],
    "contracts": [
        {
            "Name": "ChainSingleStart",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract ChainStages {\n    data {\n        Object int\n        Template int\n    }\n    conditions {\n        $templateName = DBFind(\"@1supply_templates\").Where({\"id\":$Template}).Columns(\"id,name\").One(\"name\")\n        $objectName = DBFind(\"@1supply_objects\").Where({\"id\":$Object}).Columns(\"id,name\").One(\"name\")\n        $recipientID = Int(DBFind(\"@1supply_templates\").Where({\"id\":$Template}).Columns(\"chain->recipient_id\").One(\"chain.recipient_id\"))\n        $senderID = Int(DBFind(\"@1supply_templates\").Where({\"id\":$Template}).Columns(\"chain->sender_id\").One(\"chain.sender_id\"))\n        \n        var admin_id int\n        admin_id = EcosysParam(\"role_admin\")\n       \n        if !RoleAccess(Int(admin_id)) {\n            warning LangRes(\"@1access_denied\", \"en\")\n        }\n    }\n    action {\n    var bt string m map\n    bt = BlockTime()\n    m[\"object_id\"] = $Object\n    m[\"template_id\"] = $Template\n    m[\"template_name\"] = $templateName\n    m[\"object_name\"] = $objectName\n    m[\"status\"] = 1\n    m[\"date_start\"] = bt\n    m[\"recipients_id\"] = $recipientID\n    m[\"senders_id\"] = $senderID\n    DBInsert(\"@1supply_chains\", m)\n    }\n}"
        },
        {
            "Name": "CreateObject",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract CreateObject {\n    data {\n    Name string\n    Weight int\n    image file\n    }\n    conditions {\n        $Body = $image[\"Body\"]\n        $ImageMimeType = $image[\"MimeType\"] \n\n        var admin_id int\n        admin_id = EcosysParam(\"role_admin\")\n       \n        if !RoleAccess(Int(admin_id)) {\n            warning LangRes(\"@1access_denied\", \"en\")\n        }\n    }\n\n    action {\n        var m map\n        $appId = Int(DBFind(\"@1applications\").Where({ecosystem:1, name:\"supply_chain\"}).One(\"id\"))\n        $imageId=@1UploadBinary(\"ApplicationId,Name,Data,DataMimeType\", $appId, $Name, $Body, $ImageMimeType)\n        m[\"name\"] = $Name\n        m[\"weight\"] = $Weight\n        m[\"image_id\"] = $imageId\n        m[\"status\"] = 1\n        \n        DBInsert(\"supply_objects\", m)\n    }\n}"
        },
        {
            "Name": "CreateTemplate",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract CreateTemplate {\n    data {\n        Name string\n        Sender int\n        Recipient int\n        StartingDate string\n        StartingTime string\n        EndingDate string\n        EndingTime string\n        SupplyMap string\n    }\n    func dateAddTime(d, t string) string {\n        var dt string\n        if Contains(d, \"T00:00:00Z\") {\n            d = Replace(d, \"T00:00:00Z\", \"\")\n        }\n        if Size(t) == 5 {\n            dt = Sprintf(\"%v %v:00\", d, t)\n        }\n        return dt\n    }\n    conditions {\n        var admin int\n        admin = Int(EcosysParam(\"role_admin\"))\n        if !RoleAccess(admin){\n            warning LangRes(\"@1access_denied\", \"en\")\n        }\n\n        $dateStart = UnixDateTime(dateAddTime($StartingDate, $StartingTime))\n        if $dateStart == 0 {\n            warning \"Invalid starting date\"\n        }\n        $dateEnd = UnixDateTime(dateAddTime($EndingDate, $EndingTime))\n        if $dateEnd == 0 {\n            warning \"Invalid ending date\"\n        }\n    }\n    action {\n     var m addr map encAddr string \n        addr = JSONDecode($SupplyMap)\n        addr[\"zoom\"] = 11\n        encAddr = JSONEncode(addr)\n        $senderRoleName = DBFind(\"@1roles\").Where({ecosystem:$ecosystem_id,id:$Sender, deleted:0}).One(\"role_name\")\n        $recipientRoleName = DBFind(\"@1roles\").Where({ecosystem:$ecosystem_id,id:$Recipient, deleted:0}).One(\"role_name\")\n        m[\"name\"] = $Name\n        m[\"chain\"] = {recipient_id:$Recipient,sender_id:$Sender,starting:$dateStart,ending:$dateEnd,cords:$addr,recipient_role_name:$recipientRoleName,sender_role_name:$senderRoleName}\n        m[\"counter\"] = 0\n        m[\"deleted\"] = 0\n        DBInsert(\"@1supply_templates\", m)\n    }\n}"
        }
    ],
    "data": [],
    "languages": [],
    "menus": [],
    "pages": [
        {
            "Name": "chain_object_template",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "Div(Class: content-wrapper){\n    SetTitle($create_supply_chain$)\n    Div(Class: row df f-valign){\n        Div(Class: col-md-3)\n        Div(Class: col-md-6){\n            Div(Class: panel panel-primary){\n                Div(Class: panel-heading, Body: LangRes(supply_chain))\n                Form(){\t\t\t\t\t\n                    Div(Class: list-group-item){\n                        Div(Class: row df f-valign){\n                            Div(Class: col-md-3 mt-sm text-right){\n                                Label(For: Object){\n                                    Span(Body: LangRes(object))\n                                }\n                            }\n                            Div(Class: col-md-9 mc-sm text-left){\n\t\t\t\t\t\t\t\tDBFind(@1supply_objects, src_objects)\n\t\t\t\t\t\t\t\tSelect(Name: Object, Source: src_objects, NameColumn: name, ValueColumn: id)\n                            } \n                            Div(Class: col-md-3 mt-sm text-right){\n                                Label(For: Template){\n                                    Span(Body: LangRes(template))\n                                }\n                            }\n                            Div(Class: col-md-9 mc-sm text-left){\n\t\t\t\t\t\t\t\tDBFind(@1supply_templates, src_templates)\n\t\t\t\t\t\t\t\tSelect(Name: Template, Source: src_templates, NameColumn: name, ValueColumn: id)\n                            } \n                        }\n                    }\n\n                    Div(Class: panel-footer clearfix){\n                        Div(Class: pull-right){\n\t\t\t\t\t\t\tButton(Body: LangRes(start_chain), Class: btn btn-primary, Page: @1chain_single_start, PageParams: \"object_id=Val(Object),template_id=Val(Template)\")\n                        }\n                    }\n                }\n\n            }\n        }\n\n        Div(Class: col-md-3)\n    }\n}",
            "Menu": "default_menu"
        },
        {
            "Name": "chain_single_start",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(@1supply_objects).Where({id:#object_id#}).Vars(objects)\nDBFind(@1supply_templates).Where({id:#template_id#}).Columns(\"id,name,chain->sender_id,chain->recipient_id,chain->starting,chain->ending,chain->cords,chain->sender_role_name,chain->recipient_role_name\").Vars(templates)\nDiv(content-wrapper){\n    Div(row){\n        Div(col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3){\n            Form(panel panel-default){\n                Div(panel-heading text-center){\n                    Span(Class: h3, Body: $@1chain_info$)\n                }\n                Div(panel-body){\n                    Div(form-group){\n                        Div(row){\n                            Div(col-md-12 mt-sm text-center){                               \n                                Image(Src: Binary().ById(#objects_image_id#), Class: photo).Style(height: 150px;width: 150px; border: 1px solid #5A5D63; margin-right: 10px;)\n                            }\n                        }\n                    }\n                    Div(list-group-item text-center){\n                        Div(text-muted m0 h5, Body: LangRes(@1object_name))\n                        Span(Class: h5 text-bold, Body: #objects_name#)\n                    }\n                    Div(list-group-item text-center){\n                        Div(text-muted m0 h5, Body: LangRes(@1template_name))\n                        Span(Class: h5 text-bold, Body: #templates_name#)\n                    }\n                    Div(list-group-item text-center){\n                        Div(text-muted m0 h5, Body: LangRes(@1sender_role))\n                        Span(Class: h5 text-bold, Body: #templates_chain_sender_role_name#)\n                    }\n                    Div(list-group-item text-center){\n                        Div(text-muted m0 h5, Body: LangRes(@1recipient_role))\n                        Span(Class: h5 text-bold, Body: #templates_chain_recipient_role_name#)\n                    }\n                    Div(row){\n                        Div(col-md-12 mt-lg text-center){\n                            Button(Class: btn btn-success mh-sm, Body: $@1start_chain$, Contract: @1ChainSingleStart, Page: @1supply_list, Params: \"Object=#object_id#,Template=#template_id#)\n                        }\n                    }\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu"
        },
        {
            "Name": "chains_list",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "SetVar(this_page, @1chain_list).(this_table, @1supply_chains)\nInclude(@1pager_header)\nSetTitle(\"$@chains$\")\nSpan(Class: text-muted h5 m0 mb ml-lg, Body: Span(Class: ml-sm, Body: \"$@chains_list$\"))\nDBFind(#this_table#, src).Custom(date_started){\n    Div(Class:h5){DateTime(DateTime: #date_start#, Format: \"YYYY.MM.DD HH:MI:SS\")}\n}.Custom(date_ended){\n    Div(Class:h5){DateTime(DateTime: #chain.end#, Format: \"YYYY.MM.DD HH:MI:SS\")}\n}.Custom(custom_status){\n    DBFind(#this_table#)\n    If(#status#==1){\n        Div(Class: text-normal, Body: \"$@1chain_created$\")\n    }.ElseIf(#status#==2){\n        Div(Class: text-normal, Body: \"$@chain_started$\")\n    }.ElseIf(#status#==3){\n        Div(Class: text-success, Body: \"$@chain__completed$\")\n    }.ElseIf(#status#==4){\n        Div(Class: text-warning, Body: \"$@1chain_failed$\")\n    }.Else{\n        Span(\"\")\n    }\n}\nDiv(fullscreen){\n    Div(table-responsive ml-lg mr-lg){\n        Div(list-group-item){\n            Table(src, \"$@1id$=id,$@1object_name$=object_name,$@1template_name$=template_name,$@1date_start$=date_started,$@1date_end$=date_ended,$@1status$=custom_status\")                      \n        }.Style(\n            margin-top:-15px;\n            tbody > tr:nth-of-type(odd) {\n                background-color: #f8f9fc;\n            }\n        )\n    }\n}",
            "Menu": "default_menu"
        },
        {
            "Name": "create_object",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "Div(content-wrapper){\n    Div(row){\n        Div(col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3){\n            Form(panel panel-primary){\n                Div(panel-heading, Body: LangRes(@1creating_object))\n                Div(panel-body){\n                    Div(row){\n                        Div(col-md-12 mc-sm text-left){\n                            Div(form-group){\n                                Label(){\n                                    Span(Body: LangRes(@1object_name))\n                                    Span(Class: text-danger, Body:*)\n                                }\n                                Input(Name: Name)\n                                \n                                Label(){\n                                    Span(Body: LangRes(@1object_weight))\n                                    Span(Class: text-danger, Body:*)\n                                }\n                                Input(Name: Weight)\n                                \n                                Label(){\n                                    Span(Body: LangRes(@1object_image))\n                                    Span(Class: text-danger, Body:*)\n                                }\n                                Input(Name: image, Type: file)\n                        }\n                    }\n                }\n                Div(panel-footer text-left){\n                    Button(Body: LangRes(@1back), Class: btn btn-default, Page: @1create_object)\n                    Button(Body: LangRes(@1create), Class: btn btn-primary pull-right, Page: @1objects_list, Contract: @1CreateObject).Alert(Text: \"$@1want_create_object$\", ConfirmButton: $@1yes$, CancelButton: $@1no$, Icon: question)\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu"
        },
        {
            "Name": "objects_list",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "SetVar(this_page, @1objects_list).(this_table, @1supply_objects)\nInclude(@1pager_header)\n\nSetTitle(\"$@1objects$\")\nSpan(Class: text-muted h5 m0 mb ml-lg, Body: Span(Class: ml-sm, Body: \"$@1objects_list$\"))\nAddToolButton(Title: $@1create_object$, Page: @1create_object, Icon: icon-plus).Popup(Header: $@1create_object$, Width: \"50\")\n\nDBFind(#this_table#, src).Custom(custom_status){\n    DBFind(#this_table#)\n    If(#status#==1){\n        Div(Class: text-normal, Body: \"$@1created$\")\n    }.ElseIf(#status#==2){\n        Div(Class: text-normal, Body: \"$@1in_chain$\")\n    }.ElseIf(#status#==3){\n        Div(Class: text-success, Body: \"$@1delivered$\")\n    }.ElseIf(#status#==4){\n        Div(Class: text-warning, Body: \"$@1delivery_failed$\")\n    }.Else{\n        Span(\"\")\n    }\n}.Custom(custom_image){\n        Image(Src: Binary().ById(#image_id#), Class: photo).Style(height: 60px;width: 60px; border: 1px solid #5A5D63; margin-right: 10px;)\n}.Custom(custom_action){\n    DBFind(#this_table#)\n    If(#status#==1){\n        Button(Body: LangRes(@1send_by_chain), Class: btn btn-primary, Page: @1send_from_list)\n    }.ElseIf(#status#==2){\n        Button(Body: LangRes(@1view_chain), Class: btn btn-primary, Page: @1chains_view)\n    }.ElseIf(#status#==3){\n        Button(Body: LangRes(@1view_chain), Class: btn btn-primary, Page: @1chains_view)\n    }.ElseIf(#status#==4){\n        Button(Body: LangRes(@1view_chain), Class: btn btn-primary, Page: @1chains_view)\n    }.Else{\n        Span(\"\")\n    }\n}\nDiv(fullscreen){\n    Div(table-responsive ml-lg mr-lg){\n        Div(list-group-item){\n            Table(src, \"$@1id$=id,$@1image$=custom_image,$@1name$=name,$@1object_weight$=weight,$@1status$=custom_status,$@1action$=custom_action\")                      \n        }.Style(\n            margin-top:-15px;\n            tbody > tr:nth-of-type(odd) {\n                background-color: #f8f9fc;\n            }\n        )\n    }\n}",
            "Menu": "default_menu"
        },
        {
            "Name": "template_add",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "SetVar(templates, @1objects_list).(roles, @1roles)\nDBFind(@1roles, src_roles).Where({ecosystem:#ecosystem_id#})\n\nDiv(fullscreen){\n    Div(row){\n        Div(col-sm-6 col-sm-offset-3){\n            Form(mt-lg panel panel-primary){\n                Div(panel-body){\n                    Div(row mb-sm){\n                        Div(row mb-sm){\n                            Div(col-md-4 mt-sm text-right text-bold){\n                                LangRes(template_name)\n                            }\n                            Div(col-md-8 text-left){\n                                Input(Name: Name)\n                            }\n                        }\n                        Div(row mb-sm){\n                            Div(col-sm-4 mt-sm text-right text-bold){\n                                LangRes(sender)\n                            }\n                            Div(col-sm-8 text-left){\n                                Select(Name: Sender, Source: src_roles, NameColumn: role_name, ValueColumn: id)\n                            }\n                        }\n                        Div(row mb-sm){\n                            Div(col-sm-4 mt-sm text-right text-bold){\n                                LangRes(recipient)\n                            }\n                            Div(col-sm-8 text-left){\n                                Select(Name: Recipient, Source: src_roles, NameColumn: role_name, ValueColumn: id)\n                            }\n                        }\n                        Div(row mb-sm){\n                            Div(col-sm-4 mt-sm text-right text-bold){\n                                LangRes(supply_starting_date)\n                        }\n                        Div(col-sm-8 text-left){\n                            Div(row){\n                                Div(col-sm-6){\n                                   Input(Name:StartingDate, Type:date)\n                                }\n                                Div(col-sm-6){\n                                    Input(Name:StartingTime, Type:time, Value: \"00:00\")\n                                }\n                            }\n                        }\n                    }\n                    Div(row mb-sm){\n                        Div(col-sm-4 mt-sm text-right text-bold){\n                            LangRes(supply_ending_date)\n                        }\n                        Div(col-sm-8 text-left){\n                            Div(row){\n                                Div(col-sm-6){\n                                    Input(Name:EndingDate, Type:date)\n                                }\n                                Div(col-sm-6){\n                                    Input(Name:EndingTime, Type:time, Value: \"00:00\")\n                                }\n                            }\n                        }\n                    }\n                    Div(row mb-sm){\n                        Div(col-sm-4 mt text-bold text-right){\n                            LangRes(supply_map)\n                        }\n                        Div(col-sm-8 text-left){\n                            InputMap(Name: SupplyMap, Type: point, MapType: streets)\n                        }\n                    }\n                }\n                Div(panel-footer){\n                    Button(Body: LangRes(@1back), Class: btn btn-default, Page: @1template_add)\n                    Button(Body: $@1create_template$, Class: btn btn-primary pull-right, Page: @1templates_list, Contract: CreateTemplate)\n                }\n            }\n        }\n    }\n}.Style(\n    .buttons {\n        border: 1px solid #dde6e9;\n        padding: 6px 16px;\n    }\n)",
            "Menu": "default_menu"
        },
        {
            "Name": "templates_list",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "Include(@1pager_header)\nSetTitle(\"$@1templates$\")\nSpan(Class: text-muted h5 m0 mb ml-lg, Body: Span(Class: ml-sm, Body: \"$@1templates_list$\"))\nAddToolButton(Title: Add template, Page: @1template_add, Icon: icon-plus).Popup(Header: $@1create_template$, Width: \"80\")\n\nDBFind(@1supply_templates, src).Columns(\"id,name,chain->sender_id,chain->recipient_id,chain->starting,chain->ending,chain->cords,chain->sender_role_name,chain->recipient_role_name\").Custom(date_start){\n    Div(Class:h5){DateTime(DateTime: #chain.starting#, Format: \"YYYY.MM.DD HH:MI:SS\")}\n}.Custom(date_end){\n    Div(Class:h5){DateTime(DateTime: #chain.ending#, Format: \"YYYY.MM.DD HH:MI:SS\")}\n}\n\n\nDiv(fullscreen){\n    Div(table-responsive ml-lg mr-lg){\n        Div(list-group-item){\n            Table(src, \"$@1id$=id,$@1name$=name,$@1sender$=chain.sender_role_name,$@1recipient$=chain.recipient_role_name, $@1date_start$=date_start,$@1date_end$=date_end\").                   \n        }.Style(\n            margin-top:-15px;\n            tbody > tr:nth-of-type(odd) {\n                background-color: #f8f9fc;\n            }\n        )\n    }\n}",
            "Menu": "default_menu"
        }
    ],
    "parameters": [],
    "tables": [
        {
            "Name": "supply_chains",
            "Columns": "[{\"name\":\"date_end\",\"conditions\":\"true\",\"type\":\"datetime\"},{\"name\":\"date_start\",\"conditions\":\"true\",\"type\":\"datetime\"},{\"name\":\"object_id\",\"conditions\":\"{\\\"update\\\":\\\"true\\\",\\\"read\\\":\\\"true\\\"}\",\"type\":\"number\"},{\"name\":\"object_name\",\"conditions\":\"true\",\"type\":\"text\"},{\"name\":\"recipients_id\",\"conditions\":\"{\\\"update\\\":\\\"true\\\",\\\"read\\\":\\\"true\\\"}\",\"type\":\"number\"},{\"name\":\"senders_id\",\"conditions\":\"{\\\"update\\\":\\\"true\\\",\\\"read\\\":\\\"true\\\"}\",\"type\":\"number\"},{\"name\":\"status\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"template_edit\",\"conditions\":\"true\",\"type\":\"json\"},{\"name\":\"template_id\",\"conditions\":\"{\\\"update\\\":\\\"true\\\",\\\"read\\\":\\\"true\\\"}\",\"type\":\"number\"},{\"name\":\"template_name\",\"conditions\":\"true\",\"type\":\"text\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        },
        {
            "Name": "supply_objects",
            "Columns": "[{\"name\":\"image_id\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"name\",\"conditions\":\"true\",\"type\":\"text\"},{\"name\":\"status\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"weight\",\"conditions\":\"true\",\"type\":\"number\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        },
        {
            "Name": "supply_stages",
            "Columns": "[{\"name\":\"chain_id\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"recipient_id\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"recipient_sign_time\",\"conditions\":\"true\",\"type\":\"datetime\"},{\"name\":\"sender_id\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"sender_sign_time\",\"conditions\":\"true\",\"type\":\"datetime\"},{\"name\":\"stage_id\",\"conditions\":\"true\",\"type\":\"number\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        },
        {
            "Name": "supply_templates",
            "Columns": "[{\"name\":\"chain\",\"conditions\":\"true\",\"type\":\"json\"},{\"name\":\"counter\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"deleted\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"name\",\"conditions\":\"true\",\"type\":\"text\"},{\"name\":\"total_steps\",\"conditions\":\"{\\\"update\\\":\\\"true\\\",\\\"read\\\":\\\"true\\\"}\",\"type\":\"number\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        }
    ]
}