{
    "blocks": [],
    "contracts": [
        {
            "Name": "CreateObject",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract CreateObject {\n    data {\n    Name string\n    Weight int\n    image file\n    }\n    conditions {\n        $Body = $image[\"Body\"]\n        $ImageMimeType = $image[\"MimeType\"] \n    }\n\n    action {\n        var m map\n        $appId = Int(DBFind(\"@1applications\").Where({ecosystem:1, name:\"supply_chain\"}).One(\"id\"))\n        $imageId=@1UploadBinary(\"ApplicationId,Name,Data,DataMimeType\", $appId, $Name, $Body, $ImageMimeType)\n        m[\"name\"] = $Name\n        m[\"weight\"] = $Weight\n        m[\"image_id\"] = $imageId\n        m[\"status\"] = 1\n        \n        DBInsert(\"supply_objects\", m)\n    }\n}"
        },
        {
            "Name": "CreateTemplate",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract CreateTemplate {\n    data {\n        Name string\n        Sender int\n        Recipient int\n        StartingDate string\n        StartingTime string\n        EndingDate string\n        EndingTime string\n        SupplyMap string\n    }\n    func dateAddTime(d, t string) string {\n        var dt string\n        if Contains(d, \"T00:00:00Z\") {\n            d = Replace(d, \"T00:00:00Z\", \"\")\n        }\n        if Size(t) == 5 {\n            dt = Sprintf(\"%v %v:00\", d, t)\n        }\n        return dt\n    }\n    conditions {\n        var admin int\n        admin = Int(EcosysParam(\"role_admin\"))\n        if !RoleAccess(admin){\n            warning LangRes(\"@1access_denied\", \"en\")\n        }\n\n        $dateStart = UnixDateTime(dateAddTime($StartingDate, $StartingTime))\n        if $dateStart == 0 {\n            warning \"Invalid starting date\"\n        }\n        $dateEnd = UnixDateTime(dateAddTime($EndingDate, $EndingTime))\n        if $dateEnd == 0 {\n            warning \"Invalid ending date\"\n        }\n    }\n    action {\n     var m addr map encAddr string \n        addr = JSONDecode($SupplyMap)\n        addr[\"zoom\"] = 11\n        encAddr = JSONEncode(addr)\n        $senderRoleName = DBFind(\"@1roles\").Where({ecosystem:$ecosystem_id,id:$Sender, deleted:0}).One(\"role_name\")\n        $recipientRoleName = DBFind(\"@1roles\").Where({ecosystem:$ecosystem_id,id:$Recipient, deleted:0}).One(\"role_name\")\n        m[\"name\"] = $Name\n        m[\"chain\"] = {recipient_id:$Recipient,sender_id:$Sender,starting:$dateStart,ending:$dateEnd,cords:$addr,recipient_role_name:$recipientRoleName,sender_role_name:$senderRoleName}\n        m[\"counter\"] = 0\n        m[\"deleted\"] = 0\n        DBInsert(\"@1supply_templates\", m)\n    }\n}"
        }
    ],
    "data": [],
    "languages": [],
    "menus": [],
    "pages": [
        {
            "Name": "create_object",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "Div(content-wrapper){\n    Div(row){\n        Div(col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3){\n            Form(panel panel-primary){\n                Div(panel-heading, Body: LangRes(@1creating_object))\n                Div(panel-body){\n                    Div(row){\n                        Div(col-md-12 mc-sm text-left){\n                            Div(form-group){\n                                Label(){\n                                    Span(Body: LangRes(@1object_name))\n                                    Span(Class: text-danger, Body:*)\n                                }\n                                Input(Name: Name)\n                                \n                                Label(){\n                                    Span(Body: LangRes(@1object_weight))\n                                    Span(Class: text-danger, Body:*)\n                                }\n                                Input(Name: Weight)\n                                \n                                Label(){\n                                    Span(Body: LangRes(@1object_image))\n                                    Span(Class: text-danger, Body:*)\n                                }\n                                Input(Name: image, Type: file)\n                        }\n                    }\n                }\n                Div(panel-footer text-left){\n                    Button(Body: LangRes(@1back), Class: btn btn-default, Page: @1create_object)\n                    Button(Body: LangRes(@1create), Class: btn btn-primary pull-right, Page: @1objects_list, Contract: @1CreateObject).Alert(Text: \"$@1want_create_object$\", ConfirmButton: $@1yes$, CancelButton: $@1no$, Icon: question)\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu"
        },
        {
            "Name": "objects_list",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "SetVar(this_page, @1objects_list).(this_table, @1supply_objects)\nInclude(@1pager_header)\n\nSetTitle(\"$@1objects$\")\nSpan(Class: text-muted h5 m0 mb ml-lg, Body: Span(Class: ml-sm, Body: \"$@1objects_list$\"))\nAddToolButton(Title: $@1create_object$, Page: @1create_object, Icon: icon-plus).Popup(Header: $@1create_object$, Width: \"50\")\n\nDBFind(#this_table#, src).Custom(custom_status){\n    DBFind(#this_table#)\n    If(#status#==1){\n        Div(Class: text-normal, Body: \"$@1created$\")\n    }.ElseIf(#status#==2){\n        Div(Class: text-normal, Body: \"$@1in_chain$\")\n    }.ElseIf(#status#==3){\n        Div(Class: text-success, Body: \"$@1delivered$\")\n    }.ElseIf(#status#==4){\n        Div(Class: text-warning, Body: \"$@1delivery_failed$\")\n    }.Else{\n        Span(\"\")\n    }\n}.Custom(custom_image){\n    LinkPage(Page: lots_view, PageParams: \"Id=#id#\"){\n        Image(Src: Binary().ById(#image_id#), Class: photo).Style(height: 60px;width: 60px; border: 1px solid #5A5D63; margin-right: 10px;)\n    }\n}.Custom(custom_action){\n    DBFind(#this_table#)\n    If(#status#==1){\n        Button(Body: LangRes(@1send_by_chain), Class: btn btn-primary, Page: @1objects_list)\n    }.ElseIf(#status#==2){\n        Button(Body: LangRes(@1view_chain), Class: btn btn-primary, Page: @1chains_view)\n    }.ElseIf(#status#==3){\n        Button(Body: LangRes(@1view_chain), Class: btn btn-primary, Page: @1chains_view)\n    }.ElseIf(#status#==4){\n        Button(Body: LangRes(@1view_chain), Class: btn btn-primary, Page: @1chains_view)\n    }.Else{\n        Span(\"\")\n    }\n}\nDiv(fullscreen){\n    Div(table-responsive ml-lg mr-lg){\n        Div(list-group-item){\n            Table(src, \"$@1id$=id,$@1image$=custom_image,$@1name$=name,$@1object_weight$=weight,$@1status$=custom_status,$@1action$=custom_action\")                      \n        }.Style(\n            margin-top:-15px;\n            tbody > tr:nth-of-type(odd) {\n                background-color: #f8f9fc;\n            }\n        )\n    }\n}",
            "Menu": "default_menu"
        }
    ],
    "parameters": [],
    "tables": [
        {
            "Name": "supply_chains",
            "Columns": "[{\"name\":\"date_end\",\"conditions\":\"true\",\"type\":\"datetime\"},{\"name\":\"date_start\",\"conditions\":\"true\",\"type\":\"datetime\"},{\"name\":\"object_id\",\"conditions\":\"{\\\"update\\\":\\\"true\\\",\\\"read\\\":\\\"true\\\"}\",\"type\":\"number\"},{\"name\":\"object_name\",\"conditions\":\"true\",\"type\":\"text\"},{\"name\":\"status\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"template_edit\",\"conditions\":\"true\",\"type\":\"json\"},{\"name\":\"template_id\",\"conditions\":\"{\\\"update\\\":\\\"true\\\",\\\"read\\\":\\\"true\\\"}\",\"type\":\"number\"},{\"name\":\"template_name\",\"conditions\":\"true\",\"type\":\"text\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        },
        {
            "Name": "supply_objects",
            "Columns": "[{\"name\":\"image_id\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"name\",\"conditions\":\"true\",\"type\":\"text\"},{\"name\":\"status\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"weight\",\"conditions\":\"true\",\"type\":\"number\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        },
        {
            "Name": "supply_stages",
            "Columns": "[{\"name\":\"chain_id\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"recipient_id\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"recipient_sign_time\",\"conditions\":\"true\",\"type\":\"datetime\"},{\"name\":\"sender_id\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"sender_sign_time\",\"conditions\":\"true\",\"type\":\"datetime\"},{\"name\":\"stage_id\",\"conditions\":\"true\",\"type\":\"number\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        },
        {
            "Name": "supply_templates",
            "Columns": "[{\"name\":\"chain\",\"conditions\":\"true\",\"type\":\"json\"},{\"name\":\"counter\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"deleted\",\"conditions\":\"true\",\"type\":\"number\"},{\"name\":\"name\",\"conditions\":\"true\",\"type\":\"text\"},{\"name\":\"total_steps\",\"conditions\":\"{\\\"update\\\":\\\"true\\\",\\\"read\\\":\\\"true\\\"}\",\"type\":\"number\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        }
    ]
}